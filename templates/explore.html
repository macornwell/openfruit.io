{% extends "base.html" %}
{% load rest_framework %}
{% load staticfiles %}

{% load openfruit_common_tags %}

{% block title %}OpenFruit - Explore Public Fruits{% endblock %}


{% block  body %}
    <div id="location-block">
        <div id="location-map" class="google-map"></div>
        <h4>Public Fruit Filters</h4>
        <div class="btn-group" role="group" aria-label="...">
            {% for species in species_list %}
                <button type="button" class="btn btn-default" onclick="filterByType('{{ species.species_id }}')">{{ species.name }}</button>
            {% endfor %}
        </div>

<!-- Modal -->
        <div class="modal fade" id="confirm" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
            <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
                    <h4 class="modal-title" id="myModalLabel">Confirm</h4>
                </div>
                <div class="modal-body">
                    <p>Create a new <span class="event-type"></span> record on this <span class="plant"></span>?</p>
                    <p>Do you want to proceed?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary btn-ok">Confirm</button>
                </div>
            </div>
        </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}"></script>
    <script src="{% static 'js/js.cookie.js' %}"></script>
    <script src="{% static 'js/markerclusterer.js' %}"></script>
    <script src="{% static 'js/geography/googlemaps.js'%}"></script>
    <script src="{% static 'js/geography/utilities.js'%}"></script>
    <script src="{% static 'js/taxonomy/taxonomy-service.js' %}"></script>
    <script src="{% static 'js/easy_rest_data.js' %}"></script>
    <script src="{% static 'js/plantmenu.js' %}"></script>
    <script src="{% static 'js/format.js'%}"></script>
    <script>
        var userID = {{ user.id }};
        var userLocation = '{{ USER_PROFILE.location.name }}';
        var center = new openfruit.geography.LatLon({{ USER_PROFILE.location.lat }}, {{ USER_PROFILE.location.lon }});
        var easyData = new openfruit.EasyRestData();
        var menuFactory = new openfruit.PlantMenuFactory();
        var utilities = new openfruit.geography.GeoUtilities();
        var taxonomyDAL = new openfruit.taxonomy.TaxonomyService(easyData);
        var currentCenter = null;
        var currentZoom = null;
        var treeIcon = 'http://maps.google.com/mapfiles/kml/pal2/icon4.png';

        $(document).ready(function(){
            var map = new openfruit.geography.GoogleMaps('location-map', center.getLatLon(), 18);
            currentCenter = map._map.getCenter();
            currentZoom = map._map.getZoom();
            map._map.addListener('bounds_changed', function(){
                currentCenter = map._map.getCenter();
            });
            map._map.addListener('zoom_changed', function(){
                currentZoom = map._map.getZoom();
            });
            map.addMarker(center.getLatLon(), userLocation, {icon:'http://maps.google.com/mapfiles/kml/pal3/icon23.png'}, addToCluster=false);

            var confirmDialog = $('#confirm');
            confirmDialog.on('click', '.btn-ok', function(e) {
                console.log('Clicked:');
                var $modalDiv = $(e.delegateTarget);
                var id = $(this).data('recordId');
                console.log(id);
                var eventType = $(this).data('eventType');
                console.log('Event Type:');
                console.log(eventType);

                var onSuccess = function(){
                    $modalDiv.modal('hide').removeClass('loading');
                };
                var onError = function(jqXHR, textStatus, errorThrown){
                    alert('Event did NOT save. Please contact OpenFruit support. Status: ' + textStatus + '<br>' + 'Error: ' + errorThrown)
                    $modalDiv.modal('hide').removeClass('loading');
                };
                taxonomyDAL.createEventRecord(eventType, id, onSuccess, onError);
            });
            confirmDialog.on('show.bs.modal', function(e) {
                var data = $(e.relatedTarget).data();
                console.log('Data:');
                console.log(data);
                $('.plant', this).text(data.plant);
                $('.event-type', this).text(data.eventType);
                $('.btn-ok', this).data('recordId', data.recordId);
                $('.btn-ok', this).data('eventType', data.eventType);
            });
        });


        var filterByType = function(speciesID){
            console.log('Clicked:' + speciesID);

            var map = new openfruit.geography.GoogleMaps('location-map', currentCenter, currentZoom);
            map._map.addListener('bounds_changed', function(){
                currentCenter = map._map.getCenter();
            });
            map._map.addListener('zoom_changed', function(){
                currentZoom = map._map.getZoom();
            });
            map.addMarker(center.getLatLon(), userLocation, {icon:'http://maps.google.com/mapfiles/kml/pal3/icon23.png'}, addToCluster=false);

            taxonomyDAL.getPublicFruitingPlants(function(results){
                _.each(results, function(fruitingPlant){
                    var coord = utilities.textCoordinateToGMapsDict(fruitingPlant.coordinate);

                    var cultivar = fruitingPlant.cultivar_name;
                    var name = fruitingPlant.species_name;
                    if (cultivar !== ''){
                        name = cultivar;
                    }
                    var marker = map.addMarker(coord, name, {icon:treeIcon});

                    marker.addListener('click', function() {
                        var content = menuFactory.createMenu(fruitingPlant);
                        var infowindow = new google.maps.InfoWindow({
                            content: content
                        });
                        infowindow.open(map, marker);
                    });
                });
            }, includeUsers=false, species=speciesID);
            {% for plant in users_plants %}

            {% endfor %}
        };
    </script>
{% endblock %}